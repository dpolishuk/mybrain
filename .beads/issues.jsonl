{"id":"mybrain-44l","title":"Epic: Port claude-brain to OpenCode Plugin","design":"## Requirements (IMMUTABLE)\n- OpenCode plugin exports TypeScript Plugin function with event handlers\n- All Claude Code hooks ported: SessionStart → session.created, PostToolUse → tool.execute.after, Stop → session.idle\n- Mind class reused unchanged (src/core/mind.ts)\n- Utilities reused unchanged (src/utils/helpers.ts, compression.ts, memvid-lock.ts)\n- Skills work for both systems (shared skills/ directory)\n- Commands work for both systems (shared commands/ + .opencode/commands/)\n- NPM package with conditional exports for both Claude Code and OpenCode\n- One-line curl installer script for local installation\n- Feature parity: observation capture, compression, file change tracking, session summaries\n\n## Success Criteria (MUST ALL BE TRUE)\n- [ ] OpenCode plugin loads without errors\n- [ ] PostToolUse captures observations from Read/Edit/Write/Bash/Grep/Glob\n- [ ] SessionStart injects context (memory file stats, available commands)\n- [ ] Stop captures file changes via git diff + find\n- [ ] Commands work: /mind:stats, /mind:search, /mind:ask, /mind:recent\n- [ ] Skills work: memory skill injects instructions\n- [ ] NPM install works for both Claude Code and OpenCode\n- [ ] One-line installer script runs successfully\n- [ ] All existing tests still pass\n- [ ] New tests for OpenCode plugin pass\n\n## Anti-Patterns (FORBIDDEN)\n- ❌ NO duplicating Mind class code (DRY: single source of truth in src/core/mind.ts)\n- ❌ NO stdin/stdout for OpenCode hooks (idiomatic: use function parameters directly)\n- ❌ NO separate npm packages for each system (consistency: single package with conditional exports)\n- ❌ NO skipping compression in OpenCode (feature parity: must match Claude Code behavior)\n- ❌ NO breaking existing Claude Code plugin (backward compatibility: all existing features must work)\n\n## Approach\nCreate OpenCode plugin adapter in src/hooks/opencode/index.ts that reuses existing Mind class and utilities. The adapter maps Claude Code hooks to OpenCode events. Package.json uses conditional exports. Install script detects system and places files appropriately. Skills and commands are shared - OpenCode reads from .claude/skills/ natively.\n\n## Architecture\n- src/hooks/opencode/index.ts - Plugin export with event handlers\n- src/core/mind.ts - Shared Mind engine (unchanged)\n- src/utils/*.ts - Shared utilities (unchanged)\n- skills/*.md - Shared skills (work for both)\n- commands/*.md - Shared commands\n- .opencode/commands/*.md - Symlinked or copied commands\n- install.sh - One-line installer script\n- package.json - Conditional exports for both systems\n\n## Design Rationale\n### Problem\nClaude Brain only works with Claude Code. OpenCode users want persistent memory too. The plugin architecture is different (TypeScript exports vs JSON hooks), but the core functionality (Mind class, observation capture, compression) can be shared.\n\n### Research Findings\n**Codebase:**\n- src/core/mind.ts:1-429 - Mind class with remember/search/ask/stats, uses @memvid/sdk\n- src/utils/compression.ts:1-431 - ENDLESS MODE compression for large outputs\n- src/hooks/post-tool-use.ts:1-291 - Observation capture with dedup + classification\n\n**External:**\n- opencode-claude-hooks (github.com/magarcia/opencode-claude-hooks) - 80% Claude hook compatibility\n- OpenCode Plugin API - TypeScript exports with event handlers\n- .claude/skills/ path works in OpenCode (confirmed in docs)\n\n### Approaches Considered\n1. **Monorepo with conditional exports** ✓\n   - Pros: Single source of truth, shared skills/commands, easier maintenance\n   - Cons: Users get code for both systems\n   - **Chosen because:** User preference, skills already compatible, minimal new code needed\n\n2. **Workspace packages (pnpm workspaces)**\n   - Pros: Clean separation, independent versioning\n   - Cons: Three package.json files, complex publishing\n   - **Rejected because:** More maintenance overhead, user wanted monorepo\n\n3. **Adapter pattern**\n   - Pros: Minimal changes to existing code\n   - Cons: Less idiomatic OpenCode code\n   - **Rejected because:** Want idiomatic code for both systems\n\n### Scope Boundaries\n**In scope:**\n- OpenCode plugin with full feature parity\n- NPM package with conditional exports\n- One-line installer script\n- Shared skills/commands\n\n**Out of scope (deferred/never):**\n- OpenCode-specific features not in Claude Code version\n- Migration tool for existing memories\n- Web UI for memory management\n\n### Open Questions\n- Should commands be symlinked or copied to .opencode/commands/? (prefer symlink for DRY)\n- Exact OpenCode event types for Stop equivalent (session.idle vs session.deleted)\n- Whether to use @opencode-ai/plugin package or raw SDK","status":"open","priority":3,"issue_type":"epic","owner":"dmitry.polishuk@gmail.com","created_at":"2026-02-15T22:14:21.135957+03:00","created_by":"Dmitry Polishuk","updated_at":"2026-02-15T22:14:21.135957+03:00"}
{"id":"mybrain-9t6","title":"Task 3: Update README with OpenCode installation docs","design":"## Goal\nUpdate README.md to document dual-platform support (Claude Code + OpenCode).\n\n## Implementation\n1. Update title/description to mention dual support\n2. Add OpenCode installation section\n   - NPM install instructions\n   - opencode.json configuration\n3. Update commands section to work for both\n4. Add platform comparison table\n\n## Success Criteria\n- [ ] README mentions OpenCode in title\n- [ ] OpenCode installation section exists\n- [ ] Commands documented for both platforms\n- [ ] Platform comparison table included","status":"in_progress","priority":2,"issue_type":"feature","owner":"dmitry.polishuk@gmail.com","created_at":"2026-02-15T22:32:26.740593+03:00","created_by":"Dmitry Polishuk","updated_at":"2026-02-15T22:33:17.641986+03:00","dependencies":[{"issue_id":"mybrain-9t6","depends_on_id":"mybrain-44l","type":"parent-child","created_at":"2026-02-15T22:32:30.229497+03:00","created_by":"Dmitry Polishuk"}]}
{"id":"mybrain-rwa","title":"Task 2: Create installer script for dual-platform support","design":"## Goal\nCreate install.sh script that detects Claude Code and/or OpenCode and installs the plugin appropriately.\n\n## Implementation\n1. Create install.sh at project root\n   - Detect Claude Code via .claude/ directory existence\n   - Detect OpenCode via .opencode/ directory existence\n   - Download latest release from GitHub\n   - Install dependencies via npm install --production\n   - Create .install-version marker\n\n2. Create uninstall.sh\n   - Remove plugin files\n   - Clean up markers\n\n## Success Criteria\n- [ ] install.sh exists and is executable\n- [ ] Script detects Claude Code correctly\n- [ ] Script detects OpenCode correctly\n- [ ] Script downloads latest release\n- [ ] Script installs dependencies\n- [ ] Can be run via curl | bash","status":"closed","priority":2,"issue_type":"feature","owner":"dmitry.polishuk@gmail.com","created_at":"2026-02-15T22:32:17.331198+03:00","created_by":"Dmitry Polishuk","updated_at":"2026-02-15T22:33:12.455638+03:00","closed_at":"2026-02-15T22:33:12.455638+03:00","close_reason":"Closed","dependencies":[{"issue_id":"mybrain-rwa","depends_on_id":"mybrain-44l","type":"parent-child","created_at":"2026-02-15T22:32:30.138723+03:00","created_by":"Dmitry Polishuk"}]}
{"id":"mybrain-xwc","title":"Task 1: Create OpenCode plugin structure with basic hook mapping","design":"## Goal\nCreate the OpenCode plugin TypeScript export with event handlers that map Claude Code hooks to OpenCode events.\n\n## Effort Estimate\n4-6 hours\n\n## Implementation Checklist\n1. Create directory structure\n   - [ ] Create src/hooks/opencode/ directory\n\n2. Install dependencies\n   - [ ] Add @opencode-ai/plugin as optional peer dependency in package.json\n   - [ ] Add peerDependenciesMeta with optional: true\n   - [ ] Update package.json exports with conditional for opencode\n\n3. Create plugin entry point (src/hooks/opencode/index.ts)\n   - [ ] Import Plugin type from @opencode-ai/plugin\n   - [ ] Import getMind, classifyObservationType, compressToolOutput from existing modules\n   - [ ] Export Plugin function with ctx parameter\n   - [ ] Return object with tool.execute.after handler\n   - [ ] Return object with event handler for session.created\n   - [ ] Return object with event handler for session.idle\n\n4. Study existing code for patterns\n   - [ ] src/hooks/post-tool-use.ts:24-36 for OBSERVED_TOOLS list\n   - [ ] src/hooks/post-tool-use.ts:149 for classifyObservationType usage\n   - [ ] src/hooks/session-start.ts:39-52 for context injection format\n   - [ ] src/hooks/stop.ts:31-106 for captureFileChanges pattern\n\n5. Write tests\n   - [ ] Create src/hooks/opencode/__tests__/index.test.ts\n   - [ ] Test tool.execute.after captures observation for Read tool\n   - [ ] Test tool.execute.after skips unobserved tools\n   - [ ] Test session.created returns context string\n\n## Success Criteria\n- [ ] src/hooks/opencode/index.ts exists and exports Plugin function\n- [ ] TypeScript compiles: `npx tsc --noEmit` passes\n- [ ] tool.execute.after handler exists and is called for Read/Edit/Write/Bash tools\n- [ ] session.created handler injects memory context (verified by test)\n- [ ] session.idle handler captures file changes (verified by test)\n- [ ] package.json has @opencode-ai/plugin in peerDependencies with optional: true\n- [ ] 3+ tests pass in src/hooks/opencode/__tests__/index.test.ts\n- [ ] npm run lint passes with no errors\n\n## Key Considerations\n\n**Edge Case: SDK Load Failure**\n- @opencode-ai/plugin may not be installed (optional dependency)\n- MUST gracefully degrade if plugin types unavailable\n- Use dynamic import with try-catch\n\n**Edge Case: Empty/Undefined Context**\n- ctx.directory may be undefined in some OpenCode versions\n- MUST use fallback: ctx.directory || process.cwd()\n- ctx.project.worktree may be preferred over ctx.directory\n\n**Edge Case: Tool Output Types**\n- OpenCode output structure differs from Claude Code\n- tool.execute.after receives { title, output, metadata } not raw string\n- MUST adapt classifyObservationType to handle OpenCode output format\n\n**Edge Case: Session ID Extraction**\n- Claude Code uses session_id from env\n- OpenCode passes sessionID in handler params\n- MUST use handler-provided sessionID, not process.env\n\n## Anti-patterns\n- ❌ NO duplicating Mind class (import from ../../core/mind.js)\n- ❌ NO stdin/stdout for OpenCode hooks (use function parameters)\n- ❌ NO hardcoded memory path (use ctx.directory)\n- ❌ NO breaking existing Claude Code hooks (separate directories)\n- ❌ NO throwing in hooks (use try-catch, continue on error)\n\n## Reference Implementation\nBased on research from opencode-claude-hooks and OpenCode Plugin API:\n\n```typescript\n// src/hooks/opencode/index.ts\nimport type { Plugin } from '@opencode-ai/plugin'\nimport { getMind } from '../../core/mind.js'\nimport { classifyObservationType } from '../../utils/helpers.js'\nimport { compressToolOutput } from '../../utils/compression.js'\n\nconst OBSERVED_TOOLS = new Set(['Read', 'Edit', 'Write', 'Bash', 'Grep', 'Glob'])\n\nexport const OpenCodeBrain: Plugin = async (ctx) =\u003e {\n  const projectDir = ctx.directory || ctx.project?.worktree || process.cwd()\n  const memoryPath = `${projectDir}/.claude/mind.mv2`\n  \n  return {\n    'tool.execute.after': async ({ tool, sessionID }, { output, metadata }) =\u003e {\n      if (!OBSERVED_TOOLS.has(tool)) return\n      try {\n        const mind = await getMind({ memoryPath })\n        const outputStr = typeof output === 'string' ? output : JSON.stringify(output)\n        await mind.remember({\n          type: classifyObservationType(tool, outputStr),\n          summary: `OpenCode ${tool} completed`,\n          content: compressToolOutput(tool, metadata, outputStr).compressed,\n          tool,\n        })\n      } catch (e) {\n        console.error('[opencode-brain] Error:', e)\n      }\n    },\n    \n    event: async ({ event }) =\u003e {\n      if (event.type === 'session.created') {\n        // Inject context - similar to session-start.ts\n      }\n      if (event.type === 'session.idle') {\n        // Capture file changes - similar to stop.ts\n      }\n    },\n  }\n}\n```","status":"closed","priority":3,"issue_type":"feature","owner":"dmitry.polishuk@gmail.com","created_at":"2026-02-15T22:14:27.985399+03:00","created_by":"Dmitry Polishuk","updated_at":"2026-02-15T22:32:04.097236+03:00","closed_at":"2026-02-15T22:32:04.097236+03:00","close_reason":"Closed","dependencies":[{"issue_id":"mybrain-xwc","depends_on_id":"mybrain-44l","type":"parent-child","created_at":"2026-02-15T22:14:30.99754+03:00","created_by":"Dmitry Polishuk"}]}
